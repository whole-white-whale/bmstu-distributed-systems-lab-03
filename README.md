# Лабораторная работа #3

![GitHub Classroom Workflow](../../workflows/GitHub%20Classroom%20Workflow/badge.svg?branch=master)

## Fault Tolerance

### Формулировка

На базе [Лабораторной работы #2](https://github.com/bmstu-rsoi/lab2-template) реализовать механизмы, увеличивающие
отказоустойчивость системы.

### Требования

1. На Gateway Service для _всех операций_ чтения реализовать паттерн Circuit Breaker. Накапливать статистику в памяти, и
   если система не ответила N раз, то в N + 1 раз вместо запроса сразу отдавать fallback. Через небольшой timeout
   выполнить запрос к реальной системе, чтобы проверить ее состояние.
2. На каждом сервисе сделать специальный endpoint `GET /manage/health`, отдающий 200 ОК, он будет использоваться для
   проверки доступности сервиса (в [Github Actions](.github/workflows/classroom.yml) в скрипте проверки готовности всех
   сервисов [wait-script.sh](scripts/wait-script.sh) и в тестах [test-script.sh](scripts/test-script.sh)).
   ```shell
   "$path"/wait-for.sh -t 120 "http://localhost:$port/manage/health" -- echo "Host localhost:$port is active"
   ```
4. В случае недоступности данных из некритичного источника (не основного), возвращается fallback-ответ. В зависимости от
   ситуации, это может быть:
    * пустой объект или массив;
    * объект, с заполненным полем (`uid` или подобным), по которому идет связь с другой системой;
    * default строка (если при этом не меняется тип переменной).
5. В задании описаны две операции, изменяющие состояния нескольких систем. В случае недоступности одной из систем,
   участвующих в этой операции, выполнить:
    1. откат всей операции;
    2. возвращать пользователю ответ об успешном завершении операции, а на Gateway Service поставить этот запрос в
       очередь для повторного выполнения.
6. Для автоматических прогонов тестов в файле [autograding.json](.github/classroom/autograding.json)
   и [classroom.yml](.github/workflows/classroom.yml) заменить `<variant>` на ваш вариант.
7. В [docker-compose.yaml](docker-compose.yaml) прописать сборку и запуск docker контейнеров.
8. Код хранить на Github, для сборки использовать Github Actions.
9. Каждый сервис должен быть завернут в docker.
10. В classroom.yml дописать шаги на сборку, прогон unit-тестов.

### Пояснения

1. Для локальной разработки можно использовать Postgres в docker.
2. Схема взаимодействия сервисов остается как в [Лабораторной работы #2](https://github.com/bmstu-rsoi/lab2-template).
3. Для реализации очереди можно использовать language native реализацию (например, BlockingQueue для Java), либо
   какую-то готовую реализацию типа RabbitMQ, Redis, ZeroMQ и т.п. Крайне нежелательно использовать реляционную базу
   данных как средство эмуляции очереди.
4. Можно использовать внешнюю очередь или запускать ее в docker.
5. Для проверки отказоустойчивости используется остановка и запуск контейнеров docker, это делает
   скрипт [test-script.sh](scripts/test-script.sh). Скрипт нужно запускать из корня проекта, т.к. он обращается к папке
   postman по вариантам.
   ```shell
   # запуск тестового сценария:
   # * <variant> – номер варианта (v1 | v2 | v3 | v4 )
   # * <service> – имя сервиса в Docker Compose
   # * <port>    – порт, на котором запущен сервис
   $ scripts/test-script.sh <variant> <service> <port>
   ```

### Прием задания

1. При получении задания у вас создается fork этого репозитория для вашего пользователя.
2. После того как все тесты успешно завершатся, в Github Classroom на Dashboard будет отмечено успешное выполнение
   тестов.

### Варианты заданий

Распределение вариантов заданий аналогично [ЛР #2](https://github.com/bmstu-rsoi/lab2-template).

1. [Flight Booking System](v1/README.md)
2. [Hotels Booking System](v2/README.md)
3. [Car Rental System](v3/README.md)
4. [Library System](v4/README.md)

## Car Rental System

Система предоставляет пользователю возможность забронировать автомобиль на выбранные даты.

Описание в формате [OpenAPI](%5Binst%5D%5Bv3%5D%20Car%20Rental%20System.yml).

##### Деградация функциональности

Если метод требует получения данных из нескольких источников, то в случае недоступности одного _не критичного_
источника, то недостающие данные возвращаются как некоторый fallback ответ, а остальные данные подставляются из
успешного запроса.

Например, метод `GET /api/v1/cars` в случае недоступности Car Service должен вернуть 500 ошибку, т.к. данные, получаемые
из этого сервиса критичные.

Для методов `GET /api/v1/rental` и `GET /api/v1/rental/{{rentalUid}}` в случае недоступности Rental Service запрос
должен вернуть 500 ошибку, а в случае недоступности Payment Service или Car Service, поля `payment` и `car` должны
содержать только uid записи (`paymentUid` и `carUid` соответственно).

##### Бронирование автомобиля

1. Запрос к Car Service для проверки, что такой автомобиль существует и доступен. Если условие выполняется, то
   автомобиль резервируется (`availability = false`). Если Car Service недоступен, то запрос завершается с ошибокой.
1. Выполняется запрос в Rental Service для создания записи о бронировании.
1. Если запрос к Rental Service завершился неудачей (500 ошибка или сервис недоступен), то выполняется откат операции
   резервирования автомобиля в Car Service (`availability = true`)
1. Выполняется запрос к Payment Service для создания оплаты.
1. Если запрос к Payment Service завершился неудачей (500 ошибка или сервис недоступен), то выполняется откат операции
   оплаты в Payment Service и в Car Service снимается резерв с автомобиля (`availability = true`).

##### Отмена бронирования автомобиля

1. Выполняется запрос к Car Service для снятия резерва с автомобиля (`availability = true`).
1. После этого выполняется запрос к Rental Service для установки флага аренды `CANCELED`. Если этот сервис недоступен,
   то на Gateway Service запрос поставить в очередь и повторять пока он не завершится успехом (timeout 10 секунд), потом
   перейти к следующему шагу.
1. Выполнить запрос к Payment Service для отмены оплаты. Если сервис недоступен, то аналогично предыдущему шагу, на
   Gateway Service запрос ставится в очередь и повторяется пока не завершится успехом (timeout 10 секунд), при этом
   пользователю отдается информация об успешном завершении всей операции.

### Данные для тестов

В тестовом сценарии выключается _Payment Service_, необходимо в переменную `serviceName` в
в [[classroom.yml](../.github/workflows/classroom.yml)] прописать его название в Heroku.

Создать данные для тестов:

```yaml
cars:
  – id: 1
    car_uid: "109b42f3-198d-4c89-9276-a7520a7120ab"
    brand: "Mercedes Benz"
    model: "GLA 250"
    registration_number: "ЛО777Х799"
    power: 249
    type: "SEDAN"
    price: 3500
    available: true
```
